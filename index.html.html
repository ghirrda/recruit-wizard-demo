<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruit Wizard | Master v85 (v70 + Smart Questions)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- VISUAL CORE: GOLDILOCKS SIZE --- */
        :root {
            --primary: #4f46e5; --primary-light: #818cf8;
            --bg: #f8fafc; --surface: #ffffff;
            --text-main: #0f172a; --text-sub: #64748b;
            --border: #e2e8f0;
            --sidebar-w: 250px;
            --success: #16a34a; --warning: #f59e0b; --danger: #dc2626;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13.5px; }

        /* --- SIDEBAR --- */
        .sidebar { width: var(--sidebar-w); background: #0f172a; color: white; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; z-index: 10; }
        .brand { font-size: 1.2rem; font-weight: 800; margin-bottom: 25px; display: flex; align-items: center; gap: 8px; color: white; letter-spacing: -0.03em; }
        .brand span { color: #818cf8; }
        
        .mode-switch { background: rgba(255,255,255,0.1); padding: 3px; border-radius: 8px; display: flex; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1); }
        .mode-btn { flex: 1; border: none; background: transparent; color: #94a3b8; padding: 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; cursor: pointer; transition: 0.2s; letter-spacing: 0.05em; }
        .mode-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .nav-item { padding: 10px 14px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; color: #94a3b8; font-weight: 500; font-size: 0.85rem; transition: 0.2s; display: flex; align-items: center; gap: 12px; }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: white; }
        .nav-item.active { background: rgba(255,255,255,0.15); color: white; font-weight: 700; border-left: 3px solid var(--primary-light); }

        /* --- MAIN AREA --- */
        .main-area { flex: 1; padding: 25px 40px; overflow-y: auto; background: #f8fafc; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 1.6rem; font-weight: 800; color: #1e293b; letter-spacing: -0.04em; }

        /* --- CARDS & LAYOUT --- */
        .view-panel { display: none; }
        .view-panel.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .grid-layout { display: grid; grid-template-columns: 1fr 1.3fr; gap: 25px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 20px; }
        .card-head { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 12px; letter-spacing: 0.05em; display:flex; justify-content:space-between; align-items:center; }

        /* --- AUDIT VISUALS --- */
        .meter-bg { width: 100%; height: 8px; background: #e2e8f0; border-radius: 10px; margin: 12px 0; overflow: hidden; }
        .meter-fill { height: 100%; background: var(--primary); transition: width 0.8s ease; }
        
        .gap-pill { display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; margin: 3px; border: 1px solid transparent; }
        .gap-pill.missing { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .gap-pill.present { background: #dcfce7; color: #15803d; border-color: #bbf7d0; }

        .summary-box { background: #f8fafc; border: 1px solid #cbd5e1; padding: 12px; border-radius: 8px; font-size: 0.8rem; color: #475569; margin-bottom: 15px; font-style: italic; border-left: 3px solid #94a3b8; }
        .summary-box strong { color: #1e293b; font-style: normal; font-weight: 700; }

        .advice-container { max-height: 300px; overflow-y: auto; padding-right: 5px; }
        .advice-card { padding: 12px; border-radius: 8px; font-size: 0.8rem; margin-top: 10px; line-height: 1.4; border: 1px solid transparent; }
        .advice-card.insight { background: #eff6ff; border-color: #bfdbfe; color: #1e40af; border-left: 3px solid #3b82f6; }
        .advice-card.alert { background: #fef2f2; border-color: #fecaca; color: #991b1b; border-left-color: #ef4444; }
        .advice-card.tip { background: #fffbeb; border-color: #fde68a; color: #92400e; border-left: 3px solid #f59e0b; }
        
        .score-display { font-size: 3.5rem; font-weight: 900; color: var(--primary); text-align: center; line-height: 1; margin: 5px 0 15px 0; }

        /* --- CANDIDATE LIST --- */
        .candidate-item { background: white; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; transition: 0.2s; overflow: hidden; }
        .candidate-item:hover { border-color: var(--primary); transform: translateX(2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        .c-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: white; }
        .c-header:hover { background: #f8fafc; }
        
        .rank-badge { width: 24px; height: 24px; background: #0f172a; color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px; font-size: 0.75rem; }
        .dna-tag { font-size: 0.6rem; background: #e0e7ff; color: #4338ca; padding: 3px 8px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-left: 10px; }
        
        .c-details { display: none; padding: 20px; background: #f8fafc; border-top: 1px solid var(--border); }
        .c-details.open { display: block; }
        
        .verdict-box { background: white; border: 1px solid #bbf7d0; padding: 12px; border-radius: 6px; font-size: 0.85rem; line-height: 1.5; color: #166534; margin-bottom: 15px; font-weight: 500; border-left: 4px solid #22c55e; }

        .evidence-list { list-style: none; padding: 0; margin: 0 0 15px 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .evidence-item { font-size: 0.8rem; margin-bottom: 8px; display: flex; gap: 10px; color: #334155; align-items: center; }
        .evidence-icon { font-weight: 900; width: 15px; }
        .evidence-icon.green { color: var(--success); }
        .evidence-icon.red { color: var(--danger); }
        
        /* VALUE GAP BOX */
        .gap-box { background: #fff1f2; padding: 12px; border-radius: 6px; border: 1px solid #fda4af; margin-bottom: 15px; font-size: 0.8rem; color: #be123c; line-height: 1.4; border-left: 4px solid #e11d48; }

        /* REWRITE AD BOX */
        .rewrite-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 8px; margin-top: 20px; display:none; }
        .rewrite-title { color: #15803d; font-weight:800; font-size:0.8rem; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.05em; }
        .rewrite-content { font-family: 'Inter', sans-serif; white-space: pre-wrap; font-size: 0.9rem; color: #1e293b; line-height: 1.6; }

        .question-box { background: white; padding: 10px 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.8rem; margin-bottom: 6px; border-left: 3px solid var(--primary); color: #334155; }

        /* --- FORMS & SKILLS --- */
        input, textarea { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; margin-bottom: 12px; background: #fff; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; box-shadow: 0 2px 4px -1px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background: #4338ca; transform: translateY(-1px); }
        
        .btn-magic { background: linear-gradient(135deg, #6366f1, #ec4899); color: white; border:none; padding:12px; border-radius:8px; font-weight:700; width:100%; cursor:pointer; margin-bottom:15px; transition:0.2s; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-magic:hover { opacity: 0.9; transform:translateY(-1px); }

        .skill-tag { padding: 4px 10px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 0.7rem; font-weight: 600; color: #475569; cursor: pointer; display: inline-block; margin: 2px; }
        .skill-tag.required { background: var(--primary); color: white; border-color: var(--primary); }
        .skill-tag.required::before { content: '‚òÖ '; }

        /* --- VAULT (RETAIN) & BATTLE --- */
        .vault-item { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; background: white; transition:0.2s; cursor: pointer; }
        .vault-item:hover { border-color: var(--primary); transform: translateX(2px); }
        
        .battle-table { display: grid; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: white; margin-top: 15px; }
        .bt-row { display: contents; }
        .bt-cell { padding: 14px; border-bottom: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; font-size: 0.8rem; vertical-align: top; }
        .bt-label-col { background: #f8fafc; font-weight: 700; color: #64748b; width: 150px; text-transform: uppercase; font-size: 0.65rem; padding-top: 16px; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand">Recruit<span>Wizard</span></div>
        
        <div class="mode-switch">
            <button id="btn-find" class="mode-btn active" onclick="window.App.setMode('find')">FIND (Recruit)</button>
            <button id="btn-retain" class="mode-btn" onclick="window.App.setMode('retain')">RETAIN (Mobility)</button>
        </div>

        <div class="nav-item active" id="nav-dash" onclick="window.App.nav('dashboard')"><span>&#128202;</span> <span id="lbl-dash">Role Audit</span></div>
        <div class="nav-item" id="nav-cand" onclick="window.App.nav('candidates')"><span>&#128101;</span> <span id="lbl-cand">Talent Pipeline</span></div>
        <div class="nav-item" id="nav-comp" onclick="window.App.nav('compare')"><span>&#9878;</span> <span id="lbl-comp">Battle Matrix</span></div>
        
        <div style="margin-top:auto; padding:15px; background:rgba(255,255,255,0.05); border-radius:10px;">
            <label style="font-size:0.75rem; color:#94a3b8; cursor:pointer;"><input type="checkbox" id="blind-mode" onchange="window.App.renderList()"> DEI Blind Mode</label>
        </div>
        <div style="margin-top:10px; font-size:0.6rem; color:#64748b; text-align:center;">System v85.0 (v70 + Smart Qs)</div>
    </nav>

    <main class="main-area">
        <div class="top-bar">
            <h1 class="page-title">Evidence Intelligence</h1>
            <div style="display:flex; gap:10px;">
                <button onclick="if(confirm('Full Reset?')){localStorage.clear();location.reload()}" style="padding:8px 16px; border:1px solid #fca5a5; color:#dc2626; border-radius:8px; background:white; cursor:pointer; font-weight:600;">Reset</button>
                <button onclick="window.print()" style="padding:8px 16px; border:1px solid #cbd5e1; background:white; border-radius:8px; font-weight:600; cursor:pointer; color:#475569;">Export Report</button>
            </div>
        </div>

        <div id="view-dashboard" class="view-panel active">
            <div id="panel-find" class="grid-layout">
                <div class="card">
                    <div class="card-head">1. Role & Title Intelligence</div>
                    <input type="text" id="role-title" placeholder="Job Title (e.g. Credit Controller)" onkeyup="window.App.analyzeJD()">
                    <textarea id="jd-text" placeholder="Paste JD text here..." oninput="window.App.analyzeJD()" style="height:150px;"></textarea>
                    
                    <div class="card-head" style="border:none; margin-top:10px;">Must-Have Skills (Star ‚òÖ to Weight)</div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="new-skill" placeholder="Add custom skill..." style="margin-bottom:0;" onkeypress="if(event.key==='Enter') window.App.addSkill()">
                        <button class="btn-primary" onclick="window.App.addSkill()" style="width:auto; padding:10px 20px;">+</button>
                    </div>
                    <div id="skill-cloud" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
                </div>
                
                <div class="card">
                    <div class="card-head">2. Deep Advert Audit</div>
                    <div id="score-advert" class="score-display">--%</div>
                    
                    <button class="btn-magic" onclick="window.App.generateAdvert()">‚ú® Generate High-Converting Ad</button>
                    
                    <div id="rewrite-output" class="rewrite-box">
                        <div class="rewrite-title">AIDA Optimized Advert (DEI Safe)</div>
                        <div id="rewrite-text" class="rewrite-content"></div>
                        <button class="btn-primary" style="margin-top:15px; font-size:0.8rem; padding:8px;" onclick="navigator.clipboard.writeText(document.getElementById('rewrite-text').innerText); alert('Copied!')">Copy Text</button>
                    </div>

                    <div class="advice-container">
                        <div id="ad-summary"></div>
                        <div id="gap-visuals" style="text-align:center; margin-bottom:15px;"></div>
                        <div id="ratio-analysis"></div>
                        <div id="expert-advice"></div>
                    </div>
                </div>
            </div>

            <div id="panel-retain" class="grid-layout" style="display:none;">
                <div class="card">
                    <div class="card-head">Define Internal Role</div>
                    <input type="text" id="vault-title" placeholder="Target Role Title">
                    <textarea id="vault-jd" placeholder="Paste Role Requirements..." style="height:150px;"></textarea>
                    <button class="btn-primary" onclick="window.App.addToVault()">Save to Vault</button>
                </div>
                <div class="card">
                    <div class="card-head">
                        <span>Role Vault</span>
                        <span style="font-size:0.7rem; background:#eff6ff; color:var(--primary); padding:2px 8px; border-radius:10px; font-weight:700;" id="vault-count">0</span>
                    </div>
                    <div id="vault-list" style="max-height:400px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <div id="view-candidates" class="view-panel">
            <div class="grid-layout">
                <div class="card">
                    <div class="card-head">Ingest Evidence</div>
                    <textarea id="cv-text" placeholder="Paste CV here..." style="height:200px;"></textarea>
                    <button class="btn-primary" onclick="window.App.addSingleCV()">Process Analysis</button>
                </div>
                <div class="card" style="background:transparent; border:none; box-shadow:none;">
                    <div class="card-head">Processed Profiles</div>
                    <div id="candidate-list"></div>
                </div>
            </div>
        </div>

        <div id="view-compare" class="view-panel">
            <div class="card">
                <div class="card-head" id="compare-head">Comparison Matrix</div>
                <div id="selector-grid" style="margin-bottom:20px; display:flex; gap:5px; flex-wrap:wrap;"></div>
                <button class="btn-primary" style="width:auto; padding:12px 30px;" onclick="window.App.generateBattle()">Generate Report</button>
                <div id="battle-output" style="margin-top:20px;"></div>
            </div>
        </div>
    </main>

    <script>
        window.App = {
            mode: 'find', 
            data: { role: "", skills: [], candidates: [], roleLibrary: [] },
            selected: [],
            
            // --- THESAURUS (v70) ---
            thesaurus: {
                "Finance": ["accounting", "ledger", "tax", "audit", "fp&a", "reporting", "payroll", "sage", "xero", "cpa", "acca", "cima", "profit", "loss", "balance sheet"],
                "Sales": ["business development", "account manager", "b2b", "closing", "pipeline", "gtm", "revenue", "negotiation", "prospecting", "quota", "ote"],
                "Tech": ["software", "engineering", "development", "coding", "stack", "frontend", "backend", "fullstack", "devops", "cloud", "saas"],
                "Java": ["spring", "jvm", "kotlin", "backend", "j2ee", "hibernate", "maven", "gradle"],
                "Marketing": ["seo", "sem", "content", "brand", "social media", "ppc", "campaign", "digital", "analytics", "copywriting", "growth", "crm"],
                "HR": ["people", "talent", "recruitment", "onboarding", "culture", "employee relations", "l&d", "human resources", "cipd"],
                "Management": ["leadership", "strategy", "director", "head of", "vp", "c-suite", "stakeholder", "manager", "team lead", "supervision"],
                "Admin": ["operations", "logistics", "supply chain", "coordinator", "scheduler", "office manager", "clerical"],
                "Credit": ["credit control", "chasing", "dso", "debt", "aged debt", "reconciliation", "cash collection"],
                "Excel": ["spreadsheets", "vlookup", "pivot tables", "macros", "vba", "modeling", "data analysis"],
                "Golang": ["go", "google go"],
                "AWS": ["amazon web services", "cloud", "ec2", "s3", "lambda"]
            },

            // DEI REPLACEMENTS
            deiDictionary: {
                "ninja": "Specialist", "rockstar": "Expert", "aggressive": "Driven", "dominant": "Leading", 
                "work hard play hard": "Balanced Culture", "manpower": "Workforce", "guru": "Subject Matter Expert",
                "hacker": "Engineer", "guys": "Team", "salesman": "Salesperson"
            },

            // HUMAN TOUCH: SENTENCE STARTERS
            starters: [
                "Proven track record in", "Strong background in", "Demonstrated experience with", 
                "Proficiency in", "Solid understanding of", "Hands-on experience with"
            ],

            // INTERNAL VAULT PRE-LOAD
            seedVault: [
                {id: 1, title: "Finance Manager", text: "Requires Finance, Budget, Forecast, Excel, Leadership."},
                {id: 2, title: "Java Developer", text: "Must have Java, AWS, SQL, Agile, React."},
                {id: 3, title: "Sales Director", text: "Sales, CRM, Strategy, Leadership, Negotiation."},
                {id: 4, title: "HR Business Partner", text: "HR, Employee Relations, Strategy, Compliance."},
                {id: 5, title: "Operations Lead", text: "Operations, Project Management, Stakeholder, Risk."}
            ],

            init: function() {
                try {
                    // NEW KEY v85 TO ENSURE CLEAN START WITH V70 LOGIC
                    const d = localStorage.getItem('rw_master_v85');
                    if(d) {
                        this.data = JSON.parse(d);
                    } else {
                        this.data.roleLibrary = this.seedVault;
                    }
                    
                    if(!this.data.roleLibrary) this.data.roleLibrary = this.seedVault;
                    if(!this.data.skills) this.data.skills = [];
                    if(!this.data.candidates) this.data.candidates = [];
                    
                    let fixed = false;
                    this.data.candidates.forEach((c, i) => {
                        this.data.candidates[i] = { ...c, ...this.calculateMatch(c.text) };
                        fixed = true;
                    });
                    if(fixed) this.save();

                    const rInput = document.getElementById('role-title');
                    if(rInput) rInput.value = this.data.role || "";
                    
                    this.renderSkills();
                    this.renderList();
                    this.setMode('find');
                } catch(e) { console.log("Init clean"); }
            },

            save: function() {
                const rInput = document.getElementById('role-title');
                if(rInput) this.data.role = rInput.value;
                localStorage.setItem('rw_master_v85', JSON.stringify(this.data));
            },

            expandConcept: function(word) {
                const lower = word.toLowerCase();
                for (const [key, synonyms] of Object.entries(this.thesaurus)) {
                    if (key.toLowerCase() === lower) return [lower, ...synonyms];
                    if (synonyms.includes(lower)) return [key.toLowerCase(), ...synonyms];
                }
                return [lower];
            },

            toTitleCase: function(str) {
                return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            },

            // --- AUTO-WRITER ENGINE (v70 Human Touch) ---
            generateAdvert: function() {
                this.analyzeJD();
                const titleInput = document.getElementById('role-title').value;
                const title = titleInput && titleInput.length > 2 ? titleInput : "Ideal Candidate";
                const raw = document.getElementById('jd-text').value;
                let clean = raw;
                for (const [bad, good] of Object.entries(this.deiDictionary)) {
                    const regex = new RegExp(`\\b${bad}\\b`, 'gi');
                    clean = clean.replace(regex, good);
                }
                const hasRemote = /remote|hybrid|home/i.test(clean) ? "Flexible/Hybrid" : "On-Site";
                const salary = clean.match(/¬£[\d,k]+|[\d,k]+ GBP/) ? clean.match(/¬£[\d,k]+|[\d,k]+ GBP/)[0] : "Competitive Salary & Benefits";
                const reqs = this.data.skills.map(s => {
                    const starter = this.starters[Math.floor(Math.random() * this.starters.length)];
                    return `‚Ä¢ ${starter} ${this.toTitleCase(s.name)}.`;
                }).join('\n');
                const html = `
**${title}**
*${hasRemote} | ${salary}*

**Are you a ${title} looking for your next challenge?**
We are looking for a driven professional to join a high-performance team. If you thrive in dynamic environments and want to make a tangible impact, this is the role for you.

**The Opportunity (Why Join?):**
‚Ä¢ Work on projects that matter.
‚Ä¢ Join a collaborative, inclusive culture.
‚Ä¢ Clear pathway for career progression.

**What you will bring (Requirements):**
${reqs}
‚Ä¢ Strong communication and stakeholder management skills.

**The Package:**
‚Ä¢ ${salary}
‚Ä¢ Comprehensive benefits package.
‚Ä¢ Commitment to work-life balance.

**Interested?**
Click Apply Now to start your journey with us.`;
                document.getElementById('rewrite-output').style.display = 'block';
                document.getElementById('rewrite-text').innerText = html.trim();
            },

            // --- AUDIT ---
            analyzeJD: function() {
                const t = document.getElementById('jd-text').value;
                const title = document.getElementById('role-title').value.toLowerCase();
                const cleanT = t.toLowerCase();
                if(cleanT.length < 20) {
                    document.getElementById('score-advert').innerText = "--%";
                    return;
                }
                let detectedConcepts = [];
                for (const [key, synonyms] of Object.entries(this.thesaurus)) {
                    const allTerms = [key.toLowerCase(), ...synonyms];
                    if (allTerms.some(term => new RegExp(`\\b${term}\\b`, 'i').test(cleanT))) {
                        detectedConcepts.push(key.toUpperCase());
                    }
                }
                const gist = detectedConcepts.length > 0 ? detectedConcepts[0] : "GENERAL";
                document.getElementById('ad-summary').innerHTML = `
                    <div class="summary-box">
                        <strong>Semantic Summary:</strong> System identifies this text as a <b>${gist}</b> role.<br>
                        Detected concepts: ${detectedConcepts.slice(0,3).join(', ')}.
                    </div>`;
                const demands = (cleanT.match(/must|require|expect|essential|need/g)||[]).length;
                const benefits = (cleanT.match(/offer|benefit|gain|opportunity|grow/g)||[]).length;
                let ratioMsg = "";
                if(demands > (benefits * 2)) {
                    ratioMsg = `<div class="advice-card insight">
                        <b>Psychological Insight (Give/Get Ratio):</b><br>
                        This ad is <b>Demanding</b>. You list ${demands} requirements but only ${benefits || 0} benefits.<br>
                        <i>Insight:</i> Ads with high demand ratios have a 40% higher bounce rate.
                    </div>`;
                }
                document.getElementById('ratio-analysis').innerHTML = ratioMsg;
                let adviceHTML = "";
                if(!cleanT.includes('salary') && !cleanT.includes('¬£')) adviceHTML += `<div class="advice-card alert"><b>Salary Missing (Critical):</b> Candidates skip ads without ranges.<br><i>Fix: Add 'Salary: ¬£40k-¬£50k' or a competitive band.</i></div>`;
                const hasKPIs = (cleanT.match(/%|revenue|growth|roi/g)||[]).length > 0;
                if(!hasKPIs) adviceHTML += `<div class="advice-card tip"><b>KPI Check (Missing):</b> You list duties, not outcomes.<br><i>Fix: Add a bullet point like 'Increase efficiency by 15%' or 'Manage budget of ¬£1M'.</i></div>`;
                if(gist === "SALES" && !cleanT.includes('commission')) adviceHTML += `<div class="advice-card alert"><b>Sales Risk:</b> Missing 'Commission' keyword.<br><i>Fix: Add 'Uncapped Commission' or 'OTE' clearly.</i></div>`;
                if(cleanT.includes('responsible for')) adviceHTML += `<div class="advice-card tip"><b>Tone Check:</b> 'Responsible for' is passive.<br><i>Fix: Change to active verbs like 'Drive', 'Build', 'Lead', or 'Create'.</i></div>`;
                document.getElementById('expert-advice').innerHTML = adviceHTML;
                let score = 0;
                let html = `<div class="meter-bg"><div class="meter-fill" style="width:0%"></div></div>`;
                const pillars = [
                    { label: "Salary/Comp", found: cleanT.includes('salary') || cleanT.includes('¬£') },
                    { label: "Outcomes/KPIs", found: hasKPIs },
                    { label: "Soft Skill DNA", found: (cleanT.match(/team|lead|culture/g)||[]).length > 0 }
                ];
                let checkHtml = "";
                pillars.forEach(p => {
                    if(p.found) score += 33;
                    checkHtml += `<span class="gap-pill ${p.found?'present':'missing'}">${p.found?'‚úì':'‚ö†Ô∏è'} ${p.label}</span>`;
                });
                document.getElementById('score-advert').innerText = Math.min(100, score) + "%";
                document.getElementById('gap-visuals').innerHTML = html.replace('0%', score+'%') + checkHtml;
                if(this.data.skills.length === 0) {
                    detectedConcepts.forEach(c => {
                        this.data.skills.push({name: c, required: false});
                    });
                    this.renderSkills();
                }
                this.save();
            },

            // --- MATCHING ---
            calculateMatch: function(text, targetJD = null) {
                const t = text.toLowerCase();
                const jdContext = targetJD ? targetJD.toLowerCase() : (document.getElementById('jd-text') ? document.getElementById('jd-text').value.toLowerCase() : "");
                let earned=0, total=0, matched=[], missing=[], semanticMatches=[];
                let activeSkills = [];
                if(targetJD) {
                    for (const [key, synonyms] of Object.entries(this.thesaurus)) {
                        if (targetJD.toLowerCase().includes(key.toLowerCase())) activeSkills.push({name: key, required: true});
                    }
                } else {
                    activeSkills = this.data.skills;
                }
                activeSkills.forEach(s => {
                    const w = s.required ? 5 : 1; 
                    total += w;
                    const synonyms = this.expandConcept(s.name);
                    let hit = null;
                    for (const syn of synonyms) {
                        const safeSyn = syn.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(`\\b${safeSyn}\\b`, 'i');
                        if (regex.test(t)) { hit = syn; break; }
                    }
                    if(hit) {
                        earned += w;
                        matched.push(s.name);
                        if(hit !== s.name.toLowerCase()) semanticMatches.push(`${s.name} (via "${hit}")`);
                    } else if(s.required) {
                        missing.push(s.name);
                    }
                });
                const techScore = total > 0 ? Math.min(100, Math.round((earned/total)*100)) : 0;
                const dna = (t.match(/strategy|lead/g)||[]).length > 2 ? 'STRATEGIC' : 'OPERATIONAL';
                let criticalGaps = missing.length > 0 ? missing : [];
                if(techScore < 100 && criticalGaps.length === 0) criticalGaps = matched.length > 0 ? [matched[0] + " (Depth)"] : ["Core Skills"];
                let evidence = [
                    `<b>DNA Match:</b> ${dna} Trajectory verified.`,
                    `<b>Skill Density:</b> ${matched.length}/${activeSkills.length} matches found.`,
                    `<b>Verified:</b> ${matched.join(', ') || 'None'}`
                ];
                if(semanticMatches.length > 0) evidence.push(`<span style="color:#059669"><b>Semantic Hits:</b> ${semanticMatches.join(', ')}</span>`);
                if(criticalGaps.length > 0) evidence.push(`<span style="color:#dc2626"><b>Gap Alert:</b> Missing ${criticalGaps.join(', ')}</span>`);
                const salesBullets = [
                    `üéØ <b>Core Tech:</b> Verified experience in ${matched.slice(0,3).join(', ') || 'general competencies'}.`,
                    `üß† <b>Work Style:</b> Operates with a ${dna} approach to problem-solving.`,
                    `üìä <b>Commercial:</b> Detected ${t.match(/%|\$|¬£/g)?.length||0} impact markers indicating ROI focus.`,
                    `üöÄ <b>Recommendation:</b> Strong fit for immediate ${jdContext.includes('lead')?'leadership':'delivery'} impact.`
                ];
                let gapReason = "";
                if(techScore === 100) gapReason = "Candidate is a complete semantic match. Focus interview on cultural fit.";
                else if(missing.length > 0) gapReason = `<b>Value Gap:</b> Missing specific evidence for <b>${missing[0]}</b>. <i>Probe: "Have you used ${missing[0]} in a commercial setting?"</i>`;
                else gapReason = `<b>Depth Issue:</b> Weak evidence for <b>${matched[0]||'Core Skills'}</b>. <i>Probe: "Walk me through your most complex project using this skill."</i>`;
                
                // --- FIXED QUESTION LOGIC (v85) ---
                const skillContext = matched.length > 0 ? this.toTitleCase(matched[0]) : "Core Skills";
                const gapContext = missing.length > 0 ? this.toTitleCase(missing[0]) : "Required Skills";
                const dnaOpposite = dna === "STRATEGIC" ? "Operational" : "Strategic";

                let questions = [
                    { label: "Expertise", text: `"Describe a complex challenge you faced involving **${skillContext}**. What was your specific contribution?"` },
                    { label: "Gap", text: `"You haven't listed **${gapContext}** on your profile. How would you handle a project requiring this?"` },
                    { label: "DNA", text: `"Your profile suggests a strong **${this.toTitleCase(dna)}** focus. Describe a time you had to adopt a **${dnaOpposite}** mindset."` },
                    { label: "Conflict", text: `"Describe a disagreement with a stakeholder. How did you resolve it?"` },
                    { label: "ROI", text: `"What is the first metric you would try to impact in your first 30 days?"` }
                ];

                const sell = `<b>Recruiter Pitch:</b> Strong ${dna} candidate with verified experience in ${matched.slice(0,3).join(', ')}.`;
                return { score: techScore, matched, dna, evidence, questions, pitch: sell, salesBullets, gapReason, missing: criticalGaps };
            },

            // --- UI FUNCTIONS ---
            setMode: function(m) {
                this.mode = m;
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btn-'+m).classList.add('active');
                document.getElementById('panel-find').style.display = m==='find'?'grid':'none';
                document.getElementById('panel-retain').style.display = m==='retain'?'grid':'none';
                document.getElementById('lbl-dash').innerText = m==='find'?"Role Audit":"Role Vault";
                document.getElementById('lbl-cand').innerText = m==='find'?"Talent Pipeline":"Employee Audit";
                document.getElementById('lbl-comp').innerText = m==='find'?"Battle Matrix":"Mobility Map";
                document.getElementById('compare-head').innerText = m==='find'?"Executive Comparison":"Internal Discovery Map";
                if(m==='retain') this.renderVault();
                this.nav('dashboard');
            },

            nav: function(id) {
                document.querySelectorAll('.view-panel').forEach(e => e.classList.remove('active'));
                document.getElementById('view-'+id).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                const map = {'dashboard':'nav-dash', 'candidates':'nav-cand', 'compare':'nav-comp'};
                document.getElementById(map[id]).classList.add('active');
                if(id==='compare') this.renderSelector();
            },

            addSkill: function() {
                const i = document.getElementById('new-skill');
                if(i.value) { this.data.skills.push({name:i.value, required:true}); i.value=""; this.renderSkills(); this.reScoreAll(); this.save(); }
            },

            renderSkills: function() {
                const c = document.getElementById('skill-cloud'); c.innerHTML="";
                this.data.skills.forEach((s,i)=>{
                    const t=document.createElement('div'); t.className=`skill-tag ${s.required?'required':''}`; t.innerText=s.name;
                    t.onclick=()=>{ this.data.skills[i].required=!this.data.skills[i].required; this.renderSkills(); this.reScoreAll(); };
                    c.appendChild(t);
                });
            },

            addSingleCV: function() {
                const txt = document.getElementById('cv-text').value;
                if(!txt) return;
                const res = this.calculateMatch(txt);
                this.data.candidates.push({ id: Date.now(), name: "Candidate "+(this.data.candidates.length+1), text: txt, ...res });
                this.renderList(); this.save(); document.getElementById('cv-text').value="";
            },

            reScoreAll: function() {
                this.data.candidates.forEach((c,i)=>{ this.data.candidates[i] = {...c, ...this.calculateMatch(c.text)}; });
                this.renderList();
            },

            renderList: function() {
                const list = document.getElementById('candidate-list'); list.innerHTML="";
                const blind = document.getElementById('blind-mode').checked;
                this.data.candidates.sort((a,b)=>b.score-a.score).forEach((c,i)=>{
                    list.innerHTML += `
                    <div class="candidate-item">
                        <div class="c-header" onclick="this.nextElementSibling.classList.toggle('open')">
                            <div class="rank-badge">${i+1}</div>
                            <div style="flex:1"><div class="c-name">${blind?'REDACTED':c.name}</div></div>
                            <div class="dna-tag">${c.dna}</div>
                            <div class="c-score" style="color:${c.score>70?'var(--primary)':'var(--warning)'}">${c.score}%</div>
                        </div>
                        <div class="c-details">
                            <div class="verdict-box">${c.pitch}</div>
                            <div class="gap-box">${c.gapReason}</div>
                            <ul class="evidence-list">${(c.evidence || []).map(e => `<li class="evidence-item"><span class="evidence-icon ${e.includes('Gap')?'red':'green'}">${e.includes('Gap')?'‚ö†Ô∏è':'‚úì'}</span> <span>${e}</span></li>`).join('')}</ul>
                            <div style="font-size:0.7rem; font-weight:700; color:#64748b; margin-bottom:10px;">INTERVIEW GUIDE</div>
                            ${c.questions.map(q=>`<div class="question-box"><b>${q.label}:</b> ${q.text}</div>`).join('')}
                        </div>
                    </div>`;
                });
            },

            addToVault: function() {
                const title = document.getElementById('vault-title').value;
                const jd = document.getElementById('vault-jd').value;
                if(!title || !jd) { alert("Please enter both a Role Title and a Description."); return; }
                this.data.roleLibrary.push({ id: Date.now(), title: title, text: jd });
                this.save();
                this.renderVault();
                document.getElementById('vault-title').value = "";
                document.getElementById('vault-jd').value = "";
            },

            renderVault: function() {
                const l = document.getElementById('vault-list'); l.innerHTML="";
                document.getElementById('vault-count').innerText=this.data.roleLibrary.length;
                this.data.roleLibrary.forEach((r,i)=>{
                    l.innerHTML+=`<div class="vault-item"><b>${r.title}</b> <button style="color:red; border:none; background:none; cursor:pointer;" onclick="window.App.delVault(${i})">√ó</button></div>`;
                });
            },

            delVault: function(i) { this.data.roleLibrary.splice(i,1); this.save(); this.renderVault(); },

            renderSelector: function() {
                const g = document.getElementById('selector-grid'); g.innerHTML="";
                this.data.candidates.forEach(c=>{
                    const b=document.createElement('div'); b.className=`skill-tag ${this.selected.includes(c.id)?'required':''}`; b.innerText=c.name;
                    b.onclick=()=>{ 
                        if(this.selected.includes(c.id)) this.selected=this.selected.filter(x=>x!==c.id);
                        else { if(this.mode==='retain') this.selected=[c.id]; else this.selected.push(c.id); }
                        this.renderSelector();
                    };
                    g.appendChild(b);
                });
            },

            generateBattle: function() {
                const out = document.getElementById('battle-output');
                if(this.mode==='find') {
                    const cands = this.data.candidates.filter(c=>this.selected.includes(c.id));
                    if(cands.length===0) return out.innerHTML="Select candidates.";
                    let html=`<div class="battle-table" style="grid-template-columns:150px repeat(${cands.length}, 1fr)">`;
                    html+=`<div class="bt-row"><div class="bt-cell bt-label-col">Candidate</div>${cands.map(c=>`<div class="bt-cell" style="font-weight:700">${c.name}</div>`).join('')}</div>`;
                    html+=`<div class="bt-row"><div class="bt-cell bt-label-col">Score</div>${cands.map(c=>`<div class="bt-cell" style="font-size:1.2rem; font-weight:800; color:var(--primary)">${c.score}%</div>`).join('')}</div>`;
                    html+=`<div class="bt-row"><div class="bt-cell bt-label-col">Executive Pitch</div>${cands.map(c => `<div class="bt-cell" style="text-align:left; font-size:0.75rem;"><ul style="padding-left:15px; margin:0;">${c.salesBullets.map(b=>`<li>${b}</li>`).join('')}</ul></div>`).join('')}</div>`;
                    html+=`<div class="bt-row"><div class="bt-cell bt-label-col">Critical Gaps</div>${cands.map(c=>`<div class="bt-cell" style="color:#dc2626; font-size:0.75rem; font-weight:600;">${(c.missing || []).slice(0,2).join(', ') || 'None'}</div>`).join('')}</div>`;
                    out.innerHTML=html+"</div>";
                } else {
                    if(this.selected.length!==1) return out.innerHTML="Select 1 Employee.";
                    const emp = this.data.candidates.find(c=>c.id===this.selected[0]);
                    let html=`<h4>Mobility Map: ${emp.name}</h4><div class="battle-table" style="grid-template-columns:1.5fr 0.5fr 2.5fr">`;
                    html+=`<div class="bt-row" style="background:#f8fafc; font-weight:700; color:#64748b; font-size:0.7rem;"><div class="bt-cell">Target Role</div><div class="bt-cell">Fit</div><div class="bt-cell">Mobility Logic</div></div>`;

                    this.data.roleLibrary.forEach(r=>{
                        const m = this.calculateMatch(emp.text, r.text);
                        let logic = "";
                        if(m.score >= 80) logic = `‚úÖ <b>Ready Now:</b> Leverages existing strength in ${m.matched.slice(0,3).join(', ')}.`;
                        else if(m.score >= 50) logic = `üìà <b>Upskill Path:</b> Has ${m.matched[0]||'DNA'} base, but needs ${m.missing.slice(0,2).join(', ')}.`;
                        else logic = `‚ö†Ô∏è <b>Long Term:</b> Gap in core skills (${m.missing.slice(0,2).join(', ')}).`;

                        html+=`<div class="bt-row"><div class="bt-cell"><b>${r.title}</b></div><div class="bt-cell" style="color:${m.score>70?'green':(m.score>40?'orange':'#dc2626')}"><b>${m.score}%</b></div><div class="bt-cell" style="font-size:0.75rem; text-align:left;">${logic}</div></div>`;
                    });
                    out.innerHTML=html+"</div>";
                }
            }
        };

        window.onload = function() { try{window.App.init()}catch(e){console.log(e); localStorage.clear(); location.reload()} };
    </script>
</body>
</html>